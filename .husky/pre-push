#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Get current branch
protected_branch='main'
current_branch=$(git rev-parse --abbrev-ref HEAD)

if [ "$current_branch" = "$protected_branch" ]; then
    echo "âš ï¸ Pushing to main branch detected!"
    echo "Running comprehensive checks..."
    
    # Run full test suite
    echo "ğŸ§ª Running full test suite..."
    npm run test
    
    # Run E2E tests if available
    if [ -f "playwright.config.js" ]; then
        echo "ğŸ­ Running E2E tests..."
        npm run test:e2e
    fi
    
    # Run security audit
    echo "ğŸ”’ Running security audit..."
    npm run security:check
    
    # Check for secrets in code
    echo "ğŸ” Scanning for secrets..."
    if command -v trufflehog >/dev/null 2>&1; then
        trufflehog filesystem . --exclude-paths .trufflehog-exclude
    else
        echo "âš ï¸ TruffleHog not installed, skipping secret scanning"
    fi
    
    # Build check
    echo "ğŸ—ï¸ Running build check..."
    npm run build
    
    echo "âœ… All pre-push checks passed for main branch!"
else
    echo "ğŸŒ¿ Pushing to feature branch: $current_branch"
    echo "Running basic checks..."
    
    # Run unit tests only for feature branches
    npm run test:frontend
    npm run test:backend
    
    echo "âœ… Basic pre-push checks passed!"
fi
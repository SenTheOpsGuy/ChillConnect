generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SEEKER
  PROVIDER
  EMPLOYEE
  MANAGER
  ADMIN
  SUPER_ADMIN
}

enum VerificationStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
}

enum BookingType {
  INCALL
  OUTCALL
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum TokenTransactionType {
  PURCHASE
  BOOKING_PAYMENT
  BOOKING_REFUND
  ESCROW_HOLD
  ESCROW_RELEASE
  WITHDRAWAL
}

enum AssignmentType {
  VERIFICATION
  BOOKING_MONITORING
}

enum TemplateCategory {
  BOOKING_COORDINATION
  SERVICE_DISCUSSION
  LOGISTICS
  SUPPORT
  SYSTEM
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  phone           String?
  passwordHash    String
  role            UserRole @default(SEEKER)
  isVerified      Boolean  @default(false)
  isAgeVerified   Boolean  @default(false)
  isPhoneVerified Boolean  @default(false)
  isEmailVerified Boolean  @default(false)
  consentGiven    Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Profile information
  profile     UserProfile?
  
  // Token wallet
  tokenWallet TokenWallet?
  
  // OTP verification
  otps        OTP[]
  
  // User bookings
  bookingsAsSeeker   Booking[] @relation("SeekerBookings")
  bookingsAsProvider Booking[] @relation("ProviderBookings")
  
  // Chat messages
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  
  // Token transactions
  tokenTransactions TokenTransaction[]

  // Chat templates created by admin
  createdTemplates ChatTemplate[]

  // Ratings
  ratingsGiven    Rating[] @relation("SeekerRatings")
  ratingsReceived Rating[] @relation("ProviderRatings")

  @@map("users")
}

model UserProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  firstName   String?
  lastName    String?
  displayName String?
  age         Int?
  phoneNumber String?
  location    String?
  bio         String?
  profilePhoto String?
  
  // Provider-specific fields
  isProvider       Boolean @default(false)
  verificationStatus String @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  services         String? // JSON string of services
  hourlyRate       Int?     // in tokens
  availability     String?  // JSON availability schedule

  // Rating fields (for providers)
  averageRating    Float?   @default(0)
  totalRatings     Int      @default(0)
  ratingBreakdown  String?  // JSON with breakdown: {"5": 10, "4": 5, "3": 2, "2": 0, "1": 0}

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("profiles")
}

model OTP {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String
  type      String   // "EMAIL_VERIFICATION", "PHONE_VERIFICATION", "PASSWORD_RESET"
  expiresAt DateTime
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  createdAt DateTime @default(now())
  
  @@map("otps")
}

model Booking {
  id          String        @id @default(uuid())
  seekerId    String
  providerId  String
  seeker      User          @relation("SeekerBookings", fields: [seekerId], references: [id])
  provider    User          @relation("ProviderBookings", fields: [providerId], references: [id])
  
  serviceType String        // "INCALL", "OUTCALL"
  status      String @default("PENDING") // "PENDING", "CONFIRMED", "IN_PROGRESS", "COMPLETED", "CANCELLED", "DISPUTED"
  
  scheduledAt DateTime
  duration    Int           // in minutes
  location    String?       // for outcall bookings
  
  tokenAmount Int           // tokens to be paid
  escrowHeld  Boolean       @default(false)
  
  // Chat for this booking
  chatId      String?       @unique
  chat        Chat?         @relation(fields: [chatId], references: [id])

  // Rating for this booking
  rating      Rating?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("bookings")
}

model Chat {
  id          String    @id @default(uuid())
  
  // Participants (stored as JSON)
  participantIds String // JSON array of user IDs
  
  // Messages
  messages    Message[]
  
  // Associated booking (optional)
  booking     Booking?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("chats")
}

model Message {
  id         String      @id @default(uuid())
  chatId     String
  chat       Chat        @relation(fields: [chatId], references: [id], onDelete: Cascade)

  senderId   String
  receiverId String
  sender     User        @relation("SentMessages", fields: [senderId], references: [id])
  receiver   User        @relation("ReceivedMessages", fields: [receiverId], references: [id])

  content    String
  type       String @default("TEXT") // "TEXT", "IMAGE", "FILE", "SYSTEM", "TEMPLATE"
  fileUrl    String?

  // Template-based messaging
  templateId String?
  template   ChatTemplate? @relation(fields: [templateId], references: [id])
  templateVariables String? // JSON object with variable values

  isRead     Boolean     @default(false)
  readAt     DateTime?

  createdAt  DateTime    @default(now())

  @@map("messages")
}

model TokenTransaction {
  id            String            @id @default(uuid())
  userId        String
  user          User              @relation(fields: [userId], references: [id])
  
  type          String            // "PURCHASE", "PAYMENT", "REFUND", "ESCROW_HOLD", "ESCROW_RELEASE"
  amount        Int               // tokens
  valueInr      Int               // equivalent INR value
  status        String @default("PENDING") // "PENDING", "COMPLETED", "FAILED", "CANCELLED"
  
  // Payment details
  paymentId     String?           // PayPal/Stripe payment ID
  paymentMethod String?           // "paypal", "stripe", etc.
  
  // Booking relation (for escrow)
  bookingId     String?
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  @@map("token_transactions")
}

model TokenWallet {
  id           String   @id @default(uuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  balance      Int      @default(0)
  totalEarned  Int      @default(0)
  totalSpent   Int      @default(0)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("token_wallets")
}

model ChatTemplate {
  id          String           @id @default(uuid())
  category    TemplateCategory
  templateText String
  description String?          // What this template is for
  variables   String[]         // Array of variable names like ["time", "location", "rate"]
  isActive    Boolean          @default(true)

  // Template management
  createdBy   String
  creator     User             @relation(fields: [createdBy], references: [id])

  // Usage tracking
  usageCount  Int              @default(0)

  // Messages using this template
  messages    Message[]

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("chat_templates")
}

model Rating {
  id          String   @id @default(uuid())
  bookingId   String   @unique
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Who rated
  seekerId    String
  seeker      User     @relation("SeekerRatings", fields: [seekerId], references: [id])

  // Who was rated
  providerId  String
  provider    User     @relation("ProviderRatings", fields: [providerId], references: [id])

  // Rating details
  rating      Int      // 1-5 stars
  review      String?  // Optional text review (max 500 chars)
  anonymous   Boolean  @default(false)

  // Provider response
  response    String?
  respondedAt DateTime?

  // Moderation
  isFlagged   Boolean  @default(false)
  flagReason  String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([providerId])
  @@index([createdAt])
  @@map("ratings")
}